<!DOCTYPE html>


<html>
    <head>
        <title>Satisfactory factory Planner</title>
        <link rel="stylesheet" href="styles.css">






    <script>
        function loadState(){
            // loadFactory()
            BuildAllTables()
            BuildAddTable()
            PowerTable()
        }
        window.addEventListener('load', loadState);
    </script>
 <!--Item Basics  -->
<script>
        // Each Pair of tiers gets its own list-> mor emodular? Maybe?
        var FactoryItems = 
        [
            [
                {id:"IronOre",Name:"Iron Ore",Asked:0,Needed:0,NeededList:[],RecipeNr: 1,Recepice:[
                    {PerBuilding:60,Buildings:0, Req:[]},
                    {PerBuilding:120,Buildings:0, Req:[]},
                    {PerBuilding:240,Buildings:0, Req:[]}
                   ]},
                {id:"IronBar",Name:"Iron Bar",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:30,Buildings:0,  Req:[{id:"IronOre",Nr:1}]}
                   ]},
                {id:"IronRod",Name:"Iron Rod",Asked:0,Needed:0,NeededList:[], RecipeNr: 0,
                    Recepice:[
                    {PerBuilding:15,Buildings:0,  Req:[{id:"IronBar",Nr:1}]}
                   ]},
                {id:"IronScrew",Name:"Iron Screw",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:40,Buildings:0,  Req:[{id:"IronRod",Nr:0.25}]}
                   ]},
                {id:"Iron Plate",Name:"Iron Plate",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"20",Buildings:0,  Req:[{id:"IronBar",Nr:1.5}]}
                   ]},
                {id:"Limestone",Name:"Limestone",Asked:0,Needed:0,NeededList:[],RecipeNr: 1, Recepice:[
                    {PerBuilding:60,Buildings:0, Req:[]},
                    {PerBuilding:120,Buildings:0, Req:[]},
                    {PerBuilding:240,Buildings:0, Req:[]}
                   ]},
                {id:"Concrete",Name:"Concrete",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"15",Buildings:0,  Req:[{id:"Limestone",Nr:3}]}
                   ]},
                {id:"CopperOre",Name:"Copper Ore",Asked:0,Needed:0,NeededList:[],RecipeNr: 1,Recepice:[
                    {PerBuilding:60,Buildings:0, Req:[]},
                    {PerBuilding:120,Buildings:0, Req:[]},
                    {PerBuilding:240,Buildings:0, Req:[]}
                   ]},
                {id:"CopperBar",Name:"Copper Bar",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:30,Buildings:0,  Req:[{id:"CopperOre",Nr:1}]}
                   ]},
                {id:"Copper Wire",Name:"Copper Wire",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"30",Buildings:0,  Req:[{id:"CopperBar",Nr:0.5}]}
                   ]},
                {id:"Cable",Name:"Cable",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"30",Buildings:0,  Req:[{id:"Copper Wire",Nr:2}]}]}
            ],
            [
                {id:"Reinforced Plate",Name:"Reinforced Plate",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"5",Buildings:0,  Req:[{id:"Iron Plate",Nr:3},{id:"IronScrew",Nr:12}]}
                   ]},
                {id:"Modular Frame",Name:"Modular Frame",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"2",Buildings:0,  Req:[{id:"Reinforced Plate",Nr:1.5},{id:"IronRod",Nr:6}]}
                   ]},
                {id:"Rotor",Name:"Rotor",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"4",Buildings:0,  Req:[{id:"IronRod",Nr:5},{id:"IronScrew",Nr:25}]}
                   ]},
                {id:"Smart Plating",Name:"Smart Plating",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"2",Buildings:0,  Req:[{id:"Reinforced Plate",Nr:1},{id:"Rotor",Nr:1}]}]}
            ],
            [
                {id:"Caterium Ore",Name:"Caterium Ore",Asked:0,Needed:0,NeededList:[],RecipeNr:1,Recepice:[
                    {PerBuilding:60,Buildings:0, Req:[]},
                    {PerBuilding:120,Buildings:0, Req:[]},
                    {PerBuilding:240,Buildings:0, Req:[]}
                   ]},
                {id:"Caterium Bar",Name:"Caterium Bar",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:15,Buildings:0,Req:[{id:"Caterium Ore",Nr:3}]}
                   ]},
                {id:"Quickwire",Name:"Quickwire",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"60",Buildings:0,Req:[{id:"Caterium Bar",Nr:0.2}]}
                   ]},
                {id:"AI Limiter",Name:"AI Limiter",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"5",Buildings:0,Req:[{id:"Copper Sheet",Nr:5},{id:"Quickwire",Nr:20}]}
                   ]},
                {id:"High-Speed Connector",Name:"High-Speed Connector",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"3.75",Buildings:0,Req:[{id:"Quickwire",Nr:56},{id:"Cable",Nr:10},{id:"Circuit Board",Nr:1}]}
                   ]},
                {id:"Quartz",Name:"Quartz",Asked:0,Needed:0,NeededList:[],RecipeNr:1,Recepice:[
                    {PerBuilding:60,Buildings:0, Req:[]},
                    {PerBuilding:120,Buildings:0, Req:[]},
                    {PerBuilding:240,Buildings:0, Req:[]}
                   ]},
                {id:"Quartz Crystal",Name:"Quartz Crystal",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"22.5",Buildings:0,Req:[{id:"Quartz",Nr:5/6}]}
                   ]},
                {id:"Crystal Oscillator",Name:"Crystal Oscillator",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"1",Buildings:0,Req:[{id:"Quartz Crystal",Nr:18},{id:"Cable",Nr:14},{id:"Reinforced Plate",Nr:2.5}]}
                   ]},
                {id:"Silica",Name:"Silica",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"37.5",Buildings:0,Req:[{id:"Quartz",Nr:0.6}]}
                   ]},
                {id:"Sulfur",Name:"Sulfur",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"120",Buildings:0,Req:[]}]}
            ],
            [
                {id:"Coal",Name:"Coal",Asked:0,Needed:0,NeededList:[],RecipeNr: 1,Recepice:[
                    {PerBuilding:60,Buildings:0, Req:[]},
                    {PerBuilding:120,Buildings:0, Req:[]},
                    {PerBuilding:240,Buildings:0, Req:[]}
                   ]},
                {id:"Water", Name: "Water", Asked:0, Needed:0, NeededList:[], RecipeNr:0, Recepice:[
                    {PerBuilding:120,Buildings:0, Req:[]}
                   ]},
                {id:"Steel Bar",Name:"Steel Bar",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"45",Buildings:0,  Req:[{id:"Coal",Nr:1},{id:"IronOre",Nr:1}]}
                   ]},
                {id:"Steel Beam",Name:"Steel Beam",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"15",Buildings:0,  Req:[{id:"Steel Bar",Nr:4}]}
                   ]},
                {id:"Steel Tube",Name:"Steel Tube",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"20",Buildings:0,  Req:[{id:"Steel Bar",Nr:1.5}]}
                   ]},
                {id:"Copper Sheet", Name:"Copper Sheet", Asked:0, Needed:0, NeededList:[],RecipeNr: 0, Recepice:[
                    {PerBuilding:10, Buildings:0,  Req:[{id:"CopperBar", Nr:2}]}
                   ]},
                {id:"Versatile Framework",Name:"Versatile Framework",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"5",Buildings:0,  Req:[{id:"Modular Frame",Nr:0.5},{id:"Steel Beam",Nr:6}]}
                   ]},
                {id:"Encased Industrial Beam",Name:"Encased Industrial Beam",Asked:0,Needed:0,NeededList:[],RecipeNr: 0, Recepice:[
                    {PerBuilding:"6",Buildings:0,  Req:[{id:"Steel Beam",Nr:4},{id:"Concrete",Nr:5}]},
                    {PerBuilding:"4",Buildings:0,  Req:[{id:"Steel Tube",Nr:7},{id:"Concrete",Nr:5}]}
                   ]},
                {id:"Stator",Name:"Stator",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"5",Buildings:0,  Req:[{id:"Copper Wire",Nr:8},{id:"Steel Tube",Nr:3}]}
                   ]},
                {id:"Motor",Name:"Motor",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"5",Buildings:0,  Req:[{id:"Rotor",Nr:2},{id:"Stator",Nr:2}]}
                   ]},
                {id:"Automated Wiring",Name:"Automated Wireng",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"2.5",Buildings:0,  Req:[{id:"Cable",Nr:20},{id:"Stator",Nr:1}]}]}
            ],
            [
                {id:"Oil",Name:"Oil",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:120,Buildings:0,Req:[]}
                   ]},
                {id:"Plastic",Name:"Plastic",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"20",Buildings:0,Req:[{id:"Oil",Nr:1.5},{id:"HeavyOilResidue",Nr:-0.5}]}
                   ]},
                {id:"Rubber",Name:"Rubber",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"20",Buildings:0,Req:[{id:"Oil",Nr:1.5},{id:"HeavyOilResidue",Nr:-1}]}
                   ]},
                {id:"HeavyOilResidue",Name:"Heavy Oil-Residue",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"0",Buildings:null,Req:[]}
                   ]},
                {id:"Polymer Resin",Name:"Polymer Resin",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"130",Buildings:0,Req:[{id:"Oil",Nr:6/13},{id:"HeavyOilResidue",Nr:-2/13}]}
                   ]},
                {id:"Petroleum Coke",Name:"Petroleum Coke",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"120",Buildings:0,Req:[{id:"HeavyOilResidue",Nr:1/3}]}
                   ]},
                {id:"Fuel",Name:"Fuel",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"40",Buildings:0,Req:[{id:"Oil",Nr:1.5},{id:"Polymer Resin",Nr:0.75}]}
                   ]},
            ],
            [
                {id:"Canister",Name:"Canister",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"60",Buildings:0,Req:[{id:"Plastic",Nr:0.5}]}
                   ]},
                {id:"Circuit Board",Name:"Circuit Board",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"7.5",Buildings:0,Req:[{id:"Copper Sheet",Nr:2},{id:"Plastic",Nr:4}]}
                   ]},
                {id:"Heavy Modular Frame",Name:"Heavy Modular Frame",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"2",Buildings:0,Req:[{id:"Modular Frame",Nr:5},{id:"Steel Tube",Nr:15},{id:"Encased Industrial Beam",Nr:5},{id:"IronScrew",Nr:100}]},
                    {PerBuilding: 45/16,Buildings:0,Req:[{id:"Modular Frame",Nr:8/3},{id:"Steel Tube",Nr:12},{id:"Encased Industrial Beam",Nr:10/3},{id:"Concrete",Nr:22/3}]}
                   ]},
                {id:"Computer",Name:"Computer",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"2.5",Buildings:0,Req:[{id:"Circuit Board",Nr:10},{id:"Cable",Nr:9},{id:"Plastic",Nr:18},{id:"IronScrew",Nr:52}]}
                   ]},
                {id:"Modular Engine",Name:"Modular Engine",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"1",Buildings:0,Req:[{id:"Motor",Nr:2},{id:"Rubber",Nr:15},{id:"Smart Plating",Nr:2}]}
                   ]},
                {id:"Adaptive Control Unit",Name:"Adaptive Control Unit",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[
                    {PerBuilding:"1",Buildings:0,Req:[{id:"Automated Wiring",Nr:15},{id:"Circuit Board",Nr:10},{id:"Heavy Modular Frame",Nr:2},{id:"Computer",Nr:2}]}]}
            ],
            [
                {id:"Bauxit",Name:"Bauxit",Asked:0,Needed:0,NeededList:[],RecipeNr:1,Recepice:[
                    {PerBuilding:60,Buildings:0,Req:[]},
                    {PerBuilding:120,Buildings:0,Req:[]},
                    {PerBuilding:240,Buildings:0,Req:[]}
                   ]},
                {id:"Alumina Solution",Name:"Alumina Solution",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"120",Buildings:0,Req:[{id:"Silica",Nr:-5/12},{id:"Water",Nr:1.5},{id:"Bauxit",Nr:1}]}
                   ]},
                {id:"Aluminum Scrap",Name:"Aluminum Scrap",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"360",Buildings:0,Req:[{id:"Alumina Solution",Nr:2/3},{id:"Coal",Nr:1/3},{id:"Water",Nr:-1/3}]}
                   ]},
                {id:"Aluminium Ingot",Name:"Aluminium Ingot",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"60",Buildings:0,Req:[{id:"Silica",Nr:1.25},{id:"Aluminum Scrap",Nr:1.5}]}
                   ]},
                {id:"Aluminum Casing",Name:"Aluminum Casing",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"60",Buildings:0,Req:[{id:"Aluminium Ingot",Nr:1.5}]}
                   ]},
                {id:"Radio Control Unit",Name:"Radio Control Unit",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"2.5",Buildings:0,Req:[{id:"Aluminum Casing",Nr:16},{id:"Crystal Oscillator",Nr:0.5},{id:"Computer",Nr:0.5}]}
                   ]},
                {id:"Supercomputer",Name:"Supercomputer",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"1.875",Buildings:0,Req:[{id:"Computer",Nr:2},{id:"AI Limiter",Nr:2},{id:"High-Speed Connector",Nr:3},{id:"Plastic",Nr:28}]}
                   ]},
                {id:"Alclad Aluminum Sheet",Name:"Alclad Aluminum Sheet",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"30",Buildings:0,Req:[{id:"Aluminium Ingot",Nr:1},{id:"CopperBar",Nr:1/3}]}
                   ]},
                {id:"Sulfuric Acid",Name:"Sulfuric Acid",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"50",Buildings:0,Req:[{id:"Water",Nr:1},{id:"Sulfur",Nr:1}]}
                   ]},
                {id:"Battery",Name:"Battery",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"20",Buildings:0,Req:[{id:"Sulfuric Acid",Nr:2.5},{id:"Alumina Solution",Nr:2},{id:"Aluminum Casing",Nr:1},{id:"Water",Nr:-1.5}]}]}
            ],
            [
                {id:"UraniumOre",Name:"Uranium Ore",Asked:0,Needed:0,NeededList:[],RecipeNr:2,Recepice:[
                    {PerBuilding:60,Buildings:2,Req:[]},    {PerBuilding:120,Buildings:2,Req:[]},    {PerBuilding:240,Buildings:0,Req:[]}]},
                {id:"Encased Uranium Cell",Name:"Encased Uranium Cell",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"25",Buildings:0,Req:[{id:"UraniumOre",Nr:2},{id:"Concrete",Nr:0.6},{id:"Sulfuric Acid",Nr:1.6},{id:"Encased Uranium Cell Return",Nr:-0.4}]}]},
                {id:"Elektromagnetic Control Rod",Name:"Elektromagnetic Control Rod",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"4",Buildings:0,Req:[{id:"AI Limiter",Nr:1},{id:"Stator",Nr:1.5}]}]},
                {id:"Uranium Fuel Rod",Name:"Uranium Fuel Rod",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"0.4",Buildings:0,Req:[{id:"Encased Uranium Cell",Nr:50},{id:"Encased Industrial Beam",Nr:3},{id:"Elektromagnetic Control Rod",Nr:5}]}]},
                {id:"Nuclear Waste",Name:"Nuclear Waste",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"0",Buildings:null,Req:[]}]},
                {id:"Nitrogen Gas",Name:"Nitrogen Gas",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"120",Buildings:0,Req:[]}]},
                {id:"Fused Modular Frame",Name:"Fused Modular Frame",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"1.5",Buildings:0,Req:[{id:"Heavy Modular Frame",Nr:1},{id:"Aluminum Casing",Nr:50},{id:"Nitrogen Gas",Nr:25}]}]},
                {id:"Heat Sink",Name:"Heat Sink",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"7.5",Buildings:0,Req:[{id:"Alclad Aluminum Sheet",Nr:5},{id:"Copper Sheet",Nr:3}]}]},
                {id:"Cooling System",Name:"Cooling System",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"6",Buildings:0,Req:[{id:"Heat Sink",Nr:2},{id:"Rubber",Nr:2},{id:"Water",Nr:5},{id:"Nitrogen Gas",Nr:25}]}]},
                {id:"Turbo Motor",Name:"Turbo Motor",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"1.875",Buildings:0,Req:[{id:"Cooling System",Nr:4},{id:"Radio Control Unit",Nr:2},{id:"Motor",Nr:4},{id:"Rubber",Nr:24}]}]},
                {id:"Nitric Acid",Name:"Nitric Acid",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"30",Buildings:0,Req:[{id:"Nitrogen Gas",Nr:4},{id:"Water",Nr:1},{id:"Iron Plate",Nr:1/3}]}]},
                {id:"Non-fissile Uranium",Name:"Non-fissile Uranium",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"50",Buildings:0,Req:[{id:"Nuclear Waste",Nr:0.75},{id:"Silica",Nr:0.5},{id:"Nitric Acid",Nr:0.3},{id:"Sulfuric Acid",Nr:0.3},{id:"Water",Nr:-0.3}]}]},
                {id:"Plutonium Pellet",Name:"Plutonium Pellet",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"30",Buildings:0,Req:[{id:"Non-fissile Uranium",Nr:10/3},{id:"Nuclear Waste",Nr:5/6},{id:"Power by Hand",Nr:500}]}]},
                {id:"Encased Plutonium Cell",Name:"Encased Plutonium Cell",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"5",Buildings:0,Req:[{id:"Plutonium Pellet",Nr:2},{id:"Concrete",Nr:4}]}]},
                {id:"PLutonium Fuel Rod",Name:"PLutonium Fuel Rod",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"0.25",Buildings:0,Req:[{id:"Encased Plutonium Cell",Nr:30},{id:"Steel Beam",Nr:18},{id:"Elektromagnetic Control Rod",Nr:6},{id:"Heat Sink",Nr:10}]}]}
            ],
            // This is no seen by the user and just for internal tracking.
            [
            {id:"Power by Hand", Name: "Power by Hand", Asked:0, Needed: 0, NeededList:[],RecipeNr:0,Recepice:[{PerBuilding:"1",Buildings:0,Req:[]}]},
            {id:"Encased Uranium Cell Return",Name:"Encased Uranium Cell Return",Asked:0,Needed:0,NeededList:[],RecipeNr:0,Recepice:[
                    {PerBuilding:"1",Buildings:0,Req:[{id:"Sulfuric Acid",Nr:1}]}
                   ]},
            ]
        ]

        function AddToFactory(NewItem, TierIndex){
            // Check if the item with the same Id already exists
            console.log(TierIndex)
            var existingItem = FactoryItems[TierIndex].find(item => item.id === NewItem.id);
            if (existingItem) {
                console.log('Item '+NewItem.id +' already exists in Tier', TierIndex);
                return; // Exit the function to avoid adding the item again
            }

            FactoryItems[TierIndex].push(NewItem);
            console.log('Item '+NewItem.id+' added to Tier', TierIndex);
        };

        function getIndex(ID){
            var lengTiers =FactoryItems.length  
            for (var j = 0; j < lengTiers; j++) {
                var foundIndex = FactoryItems[j].findIndex(item => item.id === ID);

                if(foundIndex != -1){
                    return [j, foundIndex]
                }
            }
            console.log('Cant find', ID)
            return -1
        }

</script>

<!-- Calulation of Items-->
<script>

        function AddNeeded(ID, DepItem){
            var indexFactor = getIndex(ID)
            var TierIndex = indexFactor[0]
            var ItemIndex = indexFactor[1]
            var item = FactoryItems[TierIndex][ItemIndex];

            var NeededListIndex = item.NeededList.findIndex(item => item.id === DepItem.id);
            if(NeededListIndex === -1)
            {
                item.NeededList.push(DepItem)
                item.Needed = Number(DepItem.Nr)+Number(item.Needed);
            }
            else
            {
                // console.log("ALready have ", DepItem.id )
                // console.log(item.NeededList[NeededListIndex])
                // console.log(DepItem)
                var previousNeed = item.NeededList[NeededListIndex].Nr
                item.NeededList[NeededListIndex].Nr = Number(DepItem.Nr)
                item.Needed = Number(DepItem.Nr)+Number(item.Needed) - previousNeed;
                // console.log(item.NeededList[NeededListIndex])
            }
            FactoryItems[TierIndex][ItemIndex] = item; 
            CalcOneBuilding(TierIndex, ItemIndex)
            return
        }

        // This always uses the first /standard recipe! 
        // TODO: Set standard by resorting 
        function CalcOneBuilding(j,l){
            var item =  FactoryItems[j][l]
            // Loop over items in recipe
            var length = item.Recepice[item.RecipeNr].Req.length
            for (var l = 0; l < length; l++) {
                AddNeeded(item.Recepice[item.RecipeNr].Req[l].id, {id: item.id, Nr: item.Recepice[item.RecipeNr].Req[l].Nr*item.Needed})
            }
            
        }

        function AddPowers(){
            PowerSources.forEach(Source => {
                Source.Req.forEach(ReqItem => {
                    AddNeeded(ReqItem.id, {id: Source.Name, Nr: Source.Buildings*ReqItem.Nr})
                })
            })
        }


        function CalcAllBuildings(){
            var lengTiers =FactoryItems.length  
            console.log("Tiers: ", lengTiers)
            for (var j = 0; j < lengTiers; j++) {
                var leng =FactoryItems[j].length  
                console.log("Items at tiers ", j, ": ", leng)
                for (var l = 0; l < leng; l++) {
                    FactoryItems[j][l].Needed=0;
                    FactoryItems[j][l].NeededList=[];
                }
            }
            for (var j = 0; j < lengTiers; j++) {
                var leng = FactoryItems[j].length  
                for (var l = 0; l < leng; l++) {
                    if(FactoryItems[j][l].Asked != 0)
                    {
                        FactoryItems[j][l].Needed = Number(FactoryItems[j][l].Asked)+Number(FactoryItems[j][l].Needed);
                        FactoryItems[j][l].NeededList.push({id: "out", Nr: Number(FactoryItems[j][l].Asked)});
                        CalcOneBuilding(j,l);
                    }
                }
            }
            AddPowers()
            for (var j = 0; j < lengTiers; j++) {
                var leng = FactoryItems[j].length  
                for (var l = 0; l < leng; l++) {
                    if((FactoryItems[j][l].Recepice[FactoryItems[j][l].RecipeNr].PerBuilding) == 0){
                        continue;
                    }
                    FactoryItems[j][l].Recepice[FactoryItems[j][l].RecipeNr].Buildings = (
                        Math.ceil(FactoryItems[j][l].Needed/FactoryItems[j][l].Recepice[FactoryItems[j][l].RecipeNr].PerBuilding)
                );

                }
            }
        }
</script>
<!-- BUild the Main table-->
<script>


        let debounceTimeouts = {};
        var ShowRecipesExplitily = false;
        var ShowOnlyNeeded = false;
        function togglerecipe(){
            ShowRecipesExplitily = !ShowRecipesExplitily
            console.log("Show REcipe: ", ShowRecipesExplitily)
            BuildAllTables()
        }
        function toggleShowAll(){
            ShowOnlyNeeded = !ShowOnlyNeeded
            console.log("Show REcipe: ", ShowOnlyNeeded)
            BuildAllTables()
        }

        function handleAskedInput(m, InputId,i,key){

            clearTimeout(debounceTimeouts[InputId]);
            debounceTimeouts[InputId] = setTimeout(() => {
                var Input =document.getElementById(InputId);
                console.log("New Asked:", Input.value);
                FactoryItems[m][i][key]=Input.value;
                BuildAllTables();
            }, 400);

        };

        function BuildAllTables(){
            CalcAllBuildings()
            PowerTable()
            RoadTable(0, "table-Factory0")
            RoadTable(1, "table-Factory12")
            RoadTable(2, "table-FactoryMAM")
            RoadTable(3, "table-Factory34")
            RoadTable(4, "table-Factory5")
            RoadTable(5, "table-Factory6")
            RoadTable(6, "table-Factory7")
            RoadTable(7, "table-Factory8")
            CalcFlowChart();

        }

        function RoadTable(m, TableIdentifier) {
            var tableBody = document.getElementById(TableIdentifier);
            var tbody = document.createElement('tbody'); // Create a new tbody element
            tableBody.innerHTML = ''; // Clear the table body
            var keys = Object.keys(FactoryItems[m][0]);
            keys = keys.slice(1);

            // Name
            var key = keys[0];
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = key;
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                console.log(FactoryItems[m][i].id, FactoryItems[m][i].Needed)
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                let Cell = document.createElement('td');
                Cell.textContent = FactoryItems[m][i][key];
                let CycleRecipeButton = document.createElement('button')
                CycleRecipeButton.onclick = (function(m, i) {
                    return function() {
                        FactoryItems[m][i].RecipeNr = (FactoryItems[m][i].RecipeNr + 1) % FactoryItems[m][i].Recepice.length;
                        BuildAllTables() // THis loks recursve, but the function only gets called on cklick!
                    };
                })(m, i);
                CycleRecipeButton.textContent = "Recipe "+(FactoryItems[m][i].RecipeNr+1)+"/"+(FactoryItems[m][i].Recepice.length);
                CycleRecipeButton.style.float = "right";
                Cell.appendChild(CycleRecipeButton);

                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);

            // Asked as Input
            var key = keys[1];
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = key;
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                var Item = FactoryItems[m][i];
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'Input' + Item[keys[0]] + key;
                input.oninput = handleAskedInput.bind(null, m, input.id, i, key);
                input.value = Item[key];
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 
                input.style.width= "50px"  ; 

                Cell.appendChild(input);
                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);

            // Ceil for Number
            var key = "Needed";
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = key;
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                var Cell = document.createElement('td');
                Cell.textContent = Math.ceil(Number( FactoryItems[m][i][key]));
                Row.appendChild(Cell);
                console.log(FactoryItems[m][i].id, "here")
            }
            tbody.appendChild(Row);


            // The Builings
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            {
                var TitleTable = document.createElement('table');

                var Row1 = document.createElement('tr');
                var TitleElem = document.createElement('td');
                TitleElem.textContent = "per Building";
                Row1.appendChild(TitleElem);
                TitleTable.append(Row1);
                var Row2 = document.createElement('tr');
                var TitleElem = document.createElement('td');
                TitleElem.textContent = "Buildings";
                Row2.appendChild(TitleElem);
                TitleTable.append(Row2);
                var Row3 = document.createElement('tr');
                Row3.appendChild(TitleElem);
                TitleTable.append(Row3);
                
                TitleCell.append(TitleTable);
            }
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                var TableCell = document.createElement('td');

                var Recepie = FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr];
                
                var Recepicekeys = Object.keys(Recepie);
                var RecepiceTable = document.createElement('table');
                for(var l= 0; l < 2; l++)
                {
                    var RecepiceRow =  document.createElement('tr')
                    var ValueCell = document.createElement('td');

                    ValueCell.textContent =Recepie[Recepicekeys[l]];
                    RecepiceRow.appendChild(ValueCell)
                    RecepiceTable.appendChild(RecepiceRow)
                }
                var RecepiceRow =  document.createElement('tr')

                RecepiceTable.appendChild(RecepiceRow)
                
                TableCell.appendChild(RecepiceTable);
                Row.appendChild(TableCell);
            }
            tbody.appendChild(Row);



            // Needed List as Building Numbers
            var key = keys[3];
            var PerItemRow = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.style.width = "200px"
            TitleCell.textContent = "Need per Item";
            PerItemRow.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                var Cell = document.createElement('td');
                var NeededList = FactoryItems[m][i][key];
                var NeededTable = document.createElement('table');
                for (var j = 0; j < NeededList.length; j++) {
                    var NeededRow =  document.createElement('tr')
                    var Cell1 = document.createElement('td')
                    Cell1.textContent = NeededList[j].id
                    var Cell2 = document.createElement('td')
                    Cell2.textContent = Math.ceil(NeededList[j].Nr/FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr].PerBuilding)
                    
                    if(FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr].PerBuilding == 0)
                    {
                        Cell2.textContent = "";
                    }
                    var Cell3 = document.createElement('td')
                    Cell3.textContent = Math.ceil(NeededList[j].Nr)
                    NeededRow.appendChild(Cell1)
                    NeededRow.appendChild(Cell2)
                    NeededRow.appendChild(Cell3)
                    if(NeededList[j].Nr != 0 ){
                        NeededTable.appendChild(NeededRow)
                    }
                }
                Cell.appendChild(NeededTable)
                PerItemRow.appendChild(Cell);
            }
            tbody.appendChild(PerItemRow);

            // Explicit recipe
            var RecipeExplRow = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.style.width = "200px"
            TitleCell.textContent = "Recipe used";
            RecipeExplRow.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                var Cell = document.createElement('td');
                var Recepie = FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr];
                var RecipeExplTable = document.createElement('table');
                for (var j = 0; j < Recepie.Req.length; j++) {
                    var RecipeRow =  document.createElement('tr')
                    var Cell1 = document.createElement('td')
                    Cell1.textContent = Recepie.Req[j].id
                    var Cell2 = document.createElement('td')
                    Cell2.textContent = Math.ceil(Recepie.Req[j].Nr*Recepie.PerBuilding)
                    RecipeRow.appendChild(Cell1)
                    RecipeRow.appendChild(Cell2)
                    RecipeExplTable.appendChild(RecipeRow)
                }
                Cell.appendChild(RecipeExplTable)
                RecipeExplRow.appendChild(Cell);
            }
            if(ShowRecipesExplitily){
                tbody.appendChild(RecipeExplRow);
            }

            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = "Overhead / Underclock to";
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                if(ShowOnlyNeeded && FactoryItems[m][i].Needed == 0){console.log("skip"); continue}
                var Cell = document.createElement('td');
                var recipe = FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr]
                var Overhead = recipe.Buildings*recipe.PerBuilding - FactoryItems[m][i].Needed;
                var Underclock = 1-(Overhead/recipe.PerBuilding);
                if(Underclock === 1) Underclock = 0
                if(FactoryItems[m][i].Needed < 0)
                {
                        console.log(FactoryItems[m][i].id, recipe)

                        Cell.style.background = "red";
                }
                Cell.textContent = (String(Math.floor(Overhead))
                    + " / " + String(Math.ceil(100*Underclock) ) + "%" 
                );
                if(recipe.PerBuilding == 0)
                {
                    Cell.textContent = (String(Overhead))
                }
                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);

            tableBody.appendChild(tbody)
        }
</script>

<!-- Adding new Items/Recipies-->
<script>
        var NewItem = {
                id: "", Name: "",
                Asked:0, Needed:0,
                NeededList:[],
                RecipeNr:0,
                Recepice:[
                ]
            };
            var NewRecepice = {PerBuilding:0,Buildings:0,  Req:[]}

        function NewItemAddRecipe(){
            PerBuildingField = document.getElementById("InputAddingPerBuilding")
            NewRecepice.PerBuilding = PerBuildingField.value
            NewItem.Recepice.push(NewRecepice)
            resetNewRecepice();
        }
        function AddAlternativeRecipe(ItemID)
        {
            var PerBuildingField = document.getElementById("InputAddingPerBuilding")
            NewRecepice.PerBuilding = Number(PerBuildingField.value)
            var index = getIndex(ItemID)

            FactoryItems[index[0]][index[1]].Recepice.push(NewRecepice)
            resetNewRecepice();
            return
        }

        function AddAlternative(){
            var NameField = document.getElementById("InputAddingName")
            var index = getIndex( NameField.value)
            console.log("Copying Item", NameField.value, " from", index)
            if (index === -1) return;
            var ItemCopy = structuredClone(FactoryItems[index[0]][index[1]])
            var RecepiceLength = ItemCopy.Recepice.length
            for(var i = 0; i< RecepiceLength; i++)
            {
                ItemCopy.Recepice[i].Req.push({id: ItemCopy.Id, Nr: -1})
            }
            ItemCopy.id = "Alternative" + ItemCopy.id
            ItemCopy.Name = "Alternative" + ItemCopy.Name
            AddToFactory(ItemCopy, index[0])
            BuildAllTables();
        }

        function AddNewItem(){
            NewItemAddRecipe()
            NameField = document.getElementById("InputAddingName")
            NewItem.id  = NameField.value
            NewItem.Name  = NameField.value

            
            TierField = document.getElementById("InputAddingTier");

            AddToFactory(NewItem, TierField.value)
            console.log("Addign item: ", NewItem)
            resetNewItem();
        }
        function handleAddButton(){
            var NameField = document.getElementById("InputAddingName")
            var index = getIndex( NameField.value)
            console.log("NEw item name: ", NameField.value)
            console.log("FOund at ", index)
            if( index === -1){
                AddNewItem()
            }
            else(
                AddAlternativeRecipe(NameField.value)
            )

            BuildAllTables()

        }
        function resetNewItem(){
            NewItem = {
                id: "", Name: "",
                Asked:0, Needed:0,
                NeededList:[],
                RecipeNr:0,
                Recepice:[
                ]
            };
            NewRecepice = {PerBuilding:0,Buildings:0,  Req:[]}
            BuildAddTable()
        }
        function resetNewRecepice(){
            NewRecepice = {PerBuilding:0,Buildings:0,  Req:[]}
        }
        
        function handleAddReqButton(){
            console.log("adding req")
            var ReqItem ={id: '', Nr: 1};

            ReqNameField = document.getElementById("InputAddingReqItem")
            ReqItem.id  = ReqNameField.value;
            PerBuildingField = document.getElementById("InputAddingReqNumber")
            ReqItem.Nr = Number(PerBuildingField.value)

            NewRecepice.Req.push(ReqItem)

            // Add to table to see
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = "";
            Row.appendChild(TitleCell);
            var Cell = document.createElement('td');
            Cell.textContent = ReqItem.id;
            Row.appendChild(Cell);
            var Cell = document.createElement('td');
            Cell.textContent = ReqItem.Nr;
            Row.appendChild(Cell);

            tbody = document.getElementById("tbodyAdd")
            tbody.appendChild(Row)
        }



        function BuildAddTable() {
            var tableBody = document.getElementById('add-Factory');
            var tbody = document.createElement('tbody'); // Create a new tbody element
            tbody.id = "tbodyAdd"
            tableBody.innerHTML = ''; // Clear the table body
            var keys = Object.keys(FactoryItems[0][0]);


            var TierRow = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = "Tier";
            TitleCell.style.width = "200px"
            TierRow.appendChild(TitleCell);
            {
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputAddingTier';
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 
                input.value = 3;
                Cell.appendChild(input);
                TierRow.appendChild(Cell);
            }
            tbody.appendChild(TierRow);


            {
                var key = "Name";
                var NameRow = document.createElement('tr');
                var TitleCell = document.createElement('td');
                TitleCell.textContent = key;
                NameRow.appendChild(TitleCell);
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputAdding' + key;
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 

                Cell.appendChild(input);
                NameRow.appendChild(Cell);
                tbody.appendChild(NameRow);
            }
            {
                NewItem.Recepice.forEach(function(Recipe){
                    RecipRow = document.createElement('tr');
                    var TitleCell = document.createElement('td');
                    TitleCell.textContent = "Recipe";
                    RecipRow.appendChild(TitleCell);
                    var ReqCell = document.createElement('td');
                    

                });
            }
            {
                var key = "PerBuilding";
                var PerRow = document.createElement('tr');
                var TitleCell = document.createElement('td');
                TitleCell.textContent = key;
                PerRow.appendChild(TitleCell);
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputAdding' + key;
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 

                Cell.appendChild(input);
                PerRow.appendChild(Cell);
                tbody.appendChild(PerRow);
            }

            {
                var ReqRow = document.createElement('tr');
                var TitleCell = document.createElement('td');
                TitleCell.style.whiteSpace = "pre"
                TitleCell.textContent = "Requirements\nEnter byproducts as negative needs";
                ReqRow.appendChild(TitleCell);

                {
                    var DropDownCell = document.createElement('td');
                    var DropDownSelect = document.createElement("select");
                    DropDownSelect.id = "InputAddingReqItem";

                    // Populate the drop-down with items from FactoryItems
                    FactoryItems.forEach(function(FactoryTier) {
                        FactoryTier.forEach(function(item) {
                            var option = document.createElement("option");
                            option.value = item.id;
                            option.text = item.Name;
                            DropDownSelect.appendChild(option);
                        })
                    });
                    DropDownCell.appendChild(DropDownSelect);
                    ReqRow.appendChild(DropDownCell);
                }

                {
                    var NumberCell = document.createElement('td');
                    var input = document.createElement('input');
                    input.id = 'InputAddingReqNumber';
                    input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                    input.style.opacity= 1.5  ; 

                    NumberCell.appendChild(input);
                    ReqRow.appendChild(NumberCell);
                }
                {
                var AddCell = document.createElement('td');
                var AddReqButton = document.createElement('button');
                AddReqButton.id = "AddReqButton"
                AddReqButton.textContent = "Add";
                AddReqButton.onclick=handleAddReqButton;
                AddCell.appendChild(AddReqButton);
                ReqRow.appendChild(AddCell);
                }
            
                tbody.appendChild(ReqRow);
            }

            tableBody.appendChild(tbody)
        }



</script>

<!--Saving -->
<script>

        function saveState() {
            console.log("Saveing");
            CalcAllBuildings();
            var Tiers = FactoryItems.length;
            for(var i = 0; i< Tiers; i++)
            {
                localStorage.setItem('FactoryItemsTier_'+String(i) , JSON.stringify(FactoryItems[i]));   
            }
            console.log("Saved");
            }

    
        function loadFactory() {
            var Tiers = FactoryItems.length;
            for(var i = 0; i< Tiers; i++)
            {
                var storedFactoryItemsTier     = localStorage.getItem('FactoryItemsTier_'+String(i));
                if (storedFactoryItemsTier) {
                    FactoryItems[i] = JSON.parse(storedFactoryItemsTier);
                }
            }
            console.log("Loaded state from memory")
        }
</script>

<!-- Determin the building-->
<script>
     // var Buildings = [Constructor, Assembler, Manufactorer, Refinery, Blender, smelter, Foundary, Miner, Water, Oil, NOne ]
    function BuildingType(Item){
        var fluids = ["Water", "Oil", "Fuel", "HeavyOilResidue"];
        var Ores = ["IronOre", "Iron Ore", "CopperOre", "CopperOre", "Caterium Ore", "Coal", "Quartz", "Limestone", "Bauxit", "Sulfur", "UraniumOre"];
        if(Item.Recepice[Item.RecipeNr].Req.some(req => fluids.includes(req.id)))
        {
            if(Item.Recepice[Item.RecipeNr].Req.length <3){
                return 3
            }
            else{
                return 4
            }
        }
        else{
            if(Item.Recepice[Item.RecipeNr].Req.length === 1){
                if(Item.Recepice[Item.RecipeNr].Req.some(req => Ores.includes(req.id))){
                    return 5
                }
                else{ return 0}
            }
            if(Item.Recepice[Item.RecipeNr].Req.length === 2){
                if(Item.Recepice[Item.RecipeNr].Req.some(req => Ores.includes(req.id))){
                    return 6
                }
                else{ return 1}
            }
            if(Item.Recepice[Item.RecipeNr].Req.length > 2){
                return 2
            }
        }
        if(Ores.includes(Item.id)){ return 7;}
        if(Item.id === "Water"){return 8;}
        if(Item.id === "Oil"){return 9;}
        if(Item.id === "HeavyOilResidue"){return 10;}
        if(Item.id === "Nuclear Waste"){return 10;}
        if(Item.id === "Power by Hand"){return 10;}
        console.log("No buildig matched to ", Item.id)
        return 10;
    }
    
</script>

<!-- Power-->
<script>
    var PowerSources = [
    {Name: "Biomass Burner", Buildings: 0, PerBuilding: 35, Req: []},
    {Name: "Coal Power Plant", Buildings: 0, PerBuilding: 75, Req: [{id: "Water", Nr: 45}, {id: "Coal", Nr: 15}]},
    // {Name: "Compacted Coal Power Plant", Buildings: 0, PerBuilding: 75, Req: [{id: "Water", Nr: 45}, {id: "Coal", Nr: 15}]},
    {Name: "Fuel Power Plant", Buildings: 0, PerBuilding: 125, Req: [{id: "Fuel", Nr: 15}]},
    // {Name: "Turbofuel Power Plant", Buildings: 0, PerBuilding: 125, Req: [{id: "Fuel", Nr: 15}]},
    {Name: "Uranium Power Plant", Buildings: 10, PerBuilding: 2500, Req: [{id: "Uranium Fuel Rod", Nr: 0.2},{id: "Water", Nr: 240}, {id:"Nuclear Waste", Nr: -10}]},
    ]
    // var Buildings = [Constructor, Assembler, Manufactorer, Refinery, Blender, smelter, Foundary, Miner, Water, Oil, None ]
    var BuildingsPower = [4, 15, 55, 30,75, 4, 16, 12, 20, 40, 0]
    function PowerConsumption(){
        var Demand = 0;
        FactoryItems.forEach(Tier => {
            Tier.forEach(Item=>{

                Demand += (
                    Item.Recepice[Item.RecipeNr].Buildings
                    *BuildingsPower[ BuildingType(Item)]
                )
            })
        })

        return Demand
    }

    function PowerProduction(){
        var production = 0;
        PowerSources.forEach(source => {
            production += source.Buildings*source.PerBuilding;
        })
        production += FactoryItems[FactoryItems.length-1][0].Needed
        return production
    }

    function handlePowerBuildingInput(NAME){
        var inputfield = document.getElementById('InputPower'+NAME)
        var foundIndex = PowerSources.findIndex(
            item => item.Name === NAME);
        if(foundIndex === -1){
            console.log('Cant find', ID)
            return -1
        }
        PowerSources[foundIndex].Buildings = inputfield.value;
        PowerTable()    
        BuildAllTables()
    }
    function updatePowerBar() {
        const production = Math.max(PowerProduction(), 1);
        const consumption = Math.max(1, PowerConsumption());
        const ratio = production / consumption;
        const bar = document.getElementById('power-bar');
        
        let color;
        if (ratio < 1) {
            color = 'red';
        } else if (ratio >= 1 && ratio <= 1.05) {
            color = 'yellow';
        } else {
            color = 'green';
        }
        
        const width = Math.max(5, Math.min(ratio / 1.2 * 100, 100)); // Ensure the width does not exceed 100%

        console.log(`Ratio: ${ratio}, Width: ${width}%, Color: ${color}`); // Debug log

        bar.style.width = width + '%';
        bar.style.backgroundColor = color;
        bar.textContent = String(Math.floor(ratio*100))+"%"
    }

    function PowerTable()
    {
        var tableBody = document.getElementById('table-Power');
        var tbody = document.createElement('tbody'); // Create a new tbody element
        tbody.id = "tbodyAdd"
        tableBody.innerHTML = ''; // Clear the table body
        //Titles
        {
            var TitleRow = document.createElement('tr')
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Power"
                TitleRow.appendChild(TitleCell)
            }
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Demand"
                TitleRow.appendChild(TitleCell)
            }
            PowerSources.forEach(element => {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = element.Name
                TitleRow.appendChild(TitleCell)
            });
            tbody.appendChild(TitleRow)
        }
        
        // Power Production
        {
            var ProdRow = document.createElement('tr')
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Production"
                ProdRow.appendChild(TitleCell)
            }
            {
                var TitleCell2 = document.createElement('td')
                TitleCell2.textContent = String(PowerProduction()) + "/" + String(PowerConsumption())
                ProdRow.appendChild(TitleCell2)
            }
            PowerSources.forEach(element => {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = element.Buildings*element.PerBuilding
                ProdRow.appendChild(TitleCell)
            });
            tbody.appendChild(ProdRow)
        }
        {
            var BuildingsRow = document.createElement('tr')
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Buildings"
                BuildingsRow.appendChild(TitleCell)
            }
            {
                var TitleCell2 = document.createElement('td')
                 // Create bar container and bar
                var barContainer = document.createElement('div');
                barContainer.className = 'bar-container';
                var bar = document.createElement('div');
                bar.className = 'bar';
                bar.id = 'power-bar';
                barContainer.appendChild(bar);
                /*
                var marker1 = document.createElement('div');
                marker1.className = 'marker';
                marker1.style.color = 'black'
                marker1.style.left = (1 / 1.2 * 100) + '%'; // Position of 1 on the bar
                barContainer.appendChild(marker1);
                */

                // barContainer.textContent = (PowerProduction()/PowerConsumption())
                barContainer.style.backgroundColor = "transparent";
                // Append bar container to the table cell
                TitleCell2.appendChild(barContainer);
                BuildingsRow.appendChild(TitleCell2)
            }
            PowerSources.forEach(element => {
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputPower'+element.Name;
                input.oninput = handlePowerBuildingInput.bind(null, element.Name);
                input.value = element.Buildings;
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 
                input.style.width= "50px"  ; 

                Cell.appendChild(input);
                BuildingsRow.appendChild(Cell);
            });
            tbody.appendChild(BuildingsRow)
        }
        tableBody.appendChild(tbody)
        updatePowerBar()


    }

</script>


<!-- Flow Chart-->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    // Flatten the data into nodes and links
    const flatendItems = FactoryItems.flat();
    function CalcFlowChart(){
        d3.select("#flowchart").select("svg").remove();
        const nodes = flatendItems
        .filter(item => item.Needed !== 0) 
        .map(item => ({
            id: item.id,
            name: String(item.Recepice[item.RecipeNr].Buildings) + "x " + item.Name,
            info: item
        }));

        PowerSources.forEach(Power => {
            if(Power.Buildings != 0 ){
                nodes.push({id: Power.Name, name: Power.Name, info: Power})
            }
        })

        function RescaledWidth(amount){
            return 3*(2-Math.exp(-Math.abs(amount)/50))
        }

        const links = [];
        flatendItems.forEach(item => {
            item.NeededList.forEach(Goal => {
                    if(Goal.id ==="out"){
                        return
                    }
                    if(Goal.Nr === 0){
                        return
                    }
                    if(Goal.Nr > 0){
                        links.push({ source: item.id, target: Goal.id, amount: (Goal.Nr)});
                    }
                    if(Goal.Nr < 0){
                        links.push({ source: Goal.id, target: item.id, amount: -(Goal.Nr)});
                    }
            });
        });

        console.log({ nodes, links });
        const width = window.innerWidth;
        const height = 1500;

        const svg = d3.select("#flowchart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("border", "2px solid black");

        // Define arrow marker for directed edges
        svg.append("defs").append("marker")
            .attr("id", "end-arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 10)
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("stroke", "#999")
            .attr("fill", "#999");

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(50))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter()
            .append("line")
            .attr("class", "link")
            .attr("marker-end", "url(#end-arrow)")
            .style("stroke-width", d => RescaledWidth(d.amount))
            ;

        const linkText = svg.append("g")
            .attr("class", "link-labels")
            .selectAll("text")
            .data(links)
            .enter()
            .append("text")
            .attr("class", "link-text")
            .attr("dy", -3)  // Position above the line
            .attr("text-anchor", "middle")
            .style("font-size", "12px")
            .style("fill", "#333")  // Text color
            .text(d => Math.ceil(d.amount));  // Display the value

        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("g")
            .data(nodes)
            .enter().append("g");

        node.append("circle")
            .attr("r", 10)
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("text")
            .attr("x", 15)
            .attr("dy", ".35em")
            .text(d => d.name);

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            linkText
                .attr("x", d => (d.source.x + d.target.x) / 2)
                .attr("y", d => (d.source.y + d.target.y) / 2);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
</script>

</head>

<body>

    <h1> Factory planer</h1>
        <h2> Items</h2>
        <h3> Tier 0</h3>
        <div id="table-container0">
        <table id="table-Factory0">
        </table>
        </div>
        <h3> Tiers 1 and 2</h3>
        <div id="table-container12">
        <table id="table-Factory12">
        </table>
        </div>
        <h3> MAM Research</h3>
        <div id="table-containerMAM">
        <table id="table-FactoryMAM">
        </table>
        </div>
        <h3> Tiers 3 and 4</h3>
        <div id="table-container34">
        <table id="table-Factory34">
        </table>
        </div>
        <h3> Tiers 5: Oil</h3>
        <div id="table-container5">
        <table id="table-Factory5">
        </table>
        </div>

        <h3> Tiers 6</h3>
        <div id="table-container6">
        <table id="table-Factory6">
        </table>
        </div>
        <h3> Tiers 7</h3>
        <div id="table-container7">
        <table id="table-Factory7">
        </table>
        </div>
        <h3> Tiers 8</h3>
        <div id="table-container8">
        <table id="table-Factory8">
        </table>
        </div>
        <button onclick=BuildAllTables()>Recalulate</button>
        <button onclick=saveState()>Saving</button>
        <button onclick=loadFactory()>Reload</button>
        <button onclick=togglerecipe()>Toggle Recipe</button>
        <button onclick=toggleShowAll()>Toggle All Items</button>

        <h2> Add New Recipe:</h2>
        If the name is already taken, the recipe gets added as an alternate
        <br>
        IF you want to use two recipies for the same item,
        the curent best practice is to add the alternative item as an extra Recipe
        with the item as a byprodukt and as well as main product,
        then manually set the prevered production rate as Asked.
        
        <br>
        You can also use this to create "factory modules".
        Seperatly calulate the in and output of the
        moduls, e.g. in a seperate tab, and include them as a new "Item".
        You maually have to set the number via the "asked" fields later.
        <div id="Add-container">
        <table id="add-Factory">
        </table>
        </div>
        <button id= "AddToFactoryButton" onclick=handleAddButton()>Add</button>
        <button id= "ResetNEwItem" onclick=resetNewItem()>Reset Requirements</button>
        <button id= "AddAlternative" onclick=AddAlternative()>Copy Item</button>


        <h2> Power </h2>
        <div id="table-containerpower">
            <table id="table-Power">
            </table>
        </div>

        <div id="flowchart"></div>

</body>
