<!DOCTYPE html>


<html>
    <head>
        <title>Satisfactory factory Planner</title>
        <link rel="stylesheet" href="styles.css">



    <style>
        .content {
        overflow: scroll;

        }
        table {
            border:none;
            border-collapse: collapse;
        }

        table td {
            border-left: 1px solid #000;
            border-right: 1px solid #000;
        }

        table td:first-child {
            border-left: none;
        }

        table td:last-child {
            border-right: none;
        }

    </style>



    <script>
        function loadState(){
            loadFactory()
            BuildAllTables()
            BuildAddTable()
            PowerTable()
        }
        window.addEventListener('load', loadState);
    </script>

    <!--Item Basics  -->
    <script>
        // Each Pair of tiers gets its own list-> mor emodular? Maybe?
        var FactoryItems = 
        [
            [
                {id:"IronOre",Name:"Iron Ore",Asked:0,Needed:0,NeededList:[{id:"Steel Bar",Nr:0},{id:"Iron Bar",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:120,Buildings:0, Product: 0,Req:[]},{PerBuilding:60,Buildings:0, Product: 0,Req:[]}]},
                {id:"IronBar",Name:"Iron Bar",Asked:0,Needed:0,NeededList:[{id:"Iron Plate",Nr:0},{id:"Iron Rod",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:30,Buildings:0, Product: 0, Req:[{id:"IronOre",Nr:1}]}]},
                {id:"IronRod",Name:"Iron Rod",Asked:0,Needed:0,NeededList:[{id:"Rotor",Nr:0},{id:"Modular Frame",Nr:0},{id:"Iron Screw",Nr:0}], RecipeNr: 0,
                    Recepice:[{PerBuilding:15,Buildings:0, Product: 0, Req:[{id:"IronBar",Nr:1}]}]},
                {id:"IronScrew",Name:"Iron Screw",Asked:0,Needed:0,NeededList:[{id:"Rotor",Nr:0},{id:"Reinforced Plate",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:40,Buildings:0, Product: 0, Req:[{id:"IronRod",Nr:0.25}]}]},
                {id:"Iron Plate",Name:"Iron Plate",Asked:0,Needed:0,NeededList:[{id:"Reinforced Plate",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"20",Buildings:0, Product: 0, Req:[{id:"IronBar",Nr:1.5}]}]},
                {id:"Limestone",Name:"Limestone",Asked:0,Needed:0,NeededList:[{id:"Cement",Nr:0}],RecipeNr: 0, Recepice:[{PerBuilding:120,Buildings:0, Product: 0, Req:[],Product: 0, ByProducts:[]}]},
                {id:"Cement",Name:"Cement",Asked:0,Needed:0,NeededList:[{id:"Encased Industrial Beam",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"15",Buildings:0, Product: 0, Req:[{id:"Limestone",Nr:3}]}]},
                {id:"CopperOre",Name:"Copper Ore",Asked:0,Needed:0,NeededList:[{id:"Copper Bar",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:120,Buildings:0, Product: 0, Req:[]}]},
                {id:"CopperBar",Name:"Copper Bar",Asked:0,Needed:0,NeededList:[{id:"Copper Wire",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:30,Buildings:0, Product: 0, Req:[{id:"CopperOre",Nr:1}]}]},
                {id:"Copper Wire",Name:"Copper Wire",Asked:0,Needed:0,NeededList:[{id:"Cable",Nr:0},{id:"Stator",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"30",Buildings:0, Product: 0, Req:[{id:"CopperBar",Nr:0.5}]}]},
                {id:"Cable",Name:"Cable",Asked:0,Needed:0,NeededList:[{id:"Automated Wireng",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"30",Buildings:0, Product: 0, Req:[{id:"Copper Wire",Nr:2}]}]}
            ],
            [
                {id:"Reinforced Plate",Name:"Reinforced Plate",Asked:0,Needed:0,NeededList:[{id:"Smart Plating",Nr:2},{id:"Modular Frame",Nr:7.5},{id:"out",Nr:5}],RecipeNr: 0,Recepice:[{PerBuilding:"5",Buildings:0, Product: 0, Req:[{id:"Iron Plate",Nr:3},{id:"IronScrew",Nr:12}]}]},
                {id:"Modular Frame",Name:"Modular Frame",Asked:0,Needed:0,NeededList:[{id:"Versatile Framework",Nr:2.5}],RecipeNr: 0,Recepice:[{PerBuilding:"2",Buildings:0, Product: 0, Req:[{id:"Reinforced Plate",Nr:1.5},{id:"IronRod",Nr:6}]}]},
                {id:"Rotor",Name:"Rotor",Asked:0,Needed:0,NeededList:[{id:"Motor",Nr:10},{id:"Smart Plating",Nr:2}],RecipeNr: 0,Recepice:[{PerBuilding:"4",Buildings:0, Product: 0, Req:[{id:"IronRod",Nr:5},{id:"IronScrew",Nr:25}]}]},
                {id:"Smart Plating",Name:"Smart Plating",Asked:0,Needed:0,NeededList:[{id:"out",Nr:2}],RecipeNr: 0,Recepice:[{PerBuilding:"2",Buildings:0, Product: 0, Req:[{id:"Reinforced Plate",Nr:1},{id:"Rotor",Nr:1}]}]}
            ],
            [
                {id:"Caterium Ore", Name: "Caterium Ore", Asked:0, Needed:0, NeededList: [], RecipeNr:0, Recepice:[{PerBuilding:60,Buildings:0, Product: 0,Req:[]},{PerBuilding:120,Buildings:0, Product: 0,Req:[]}]}
            ],
            [
                {id:"Coal",Name:"Coal",Asked:0,Needed:0,NeededList:[{id:"Steel Bar",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:60,Buildings:0, Product: 0, Req:[]}]},
                {id:"Water", Name: "Water", Asked:0, Needed:0, NeededList: [], RecipeNr:0, Recepice:[{PerBuilding:120,Buildings:0, Product: 0,Req:[]}]},
                {id:"Steel Bar",Name:"Steel Bar",Asked:0,Needed:0,NeededList:[{id:"Steel Tube",Nr:0},{id:"Steel Beam",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"45",Buildings:0, Product: 0, Req:[{id:"Coal",Nr:1},{id:"IronOre",Nr:1}]}]},
                {id:"Steel Beam",Name:"Steel Beam",Asked:0,Needed:0,NeededList:[{id:"Encased Industrial Beam",Nr:0},{id:"Versatile Framework",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"15",Buildings:0, Product: 0, Req:[{id:"Steel Bar",Nr:4}]}]},
                {id:"Steel Tube",Name:"Steel Tube",Asked:0,Needed:0,NeededList:[{id:"Stator",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"20",Buildings:0, Product: 0, Req:[{id:"Steel Bar",Nr:1.5}]}]},
                {id:"Copper SHeet", Name:"Copper SHeet", Asked:0, Needed:0, NeededList:[],RecipeNr: 0, Recepice:[{PerBuilding:10, Buildings:0, Product:0, Req:[{id:"CopperBar", Nr:2}]}]},
                {id:"Versatile Framework",Name:"Versatile Framework",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"5",Buildings:0, Product: 0, Req:[{id:"Modular Frame",Nr:0.5},{id:"Steel Beam",Nr:6}]}]},
                {id:"Encased Industrial Beam",Name:"Encased Industrial Beam",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"6",Buildings:0, Product: 0, Req:[{id:"Steel Beam",Nr:4},{id:"Cement",Nr:5}]}]},
                {id:"Stator",Name:"Stator",Asked:0,Needed:0,NeededList:[{id:"Automated Wireng",Nr:0},{id:"Motor",Nr:0}],RecipeNr: 0,Recepice:[{PerBuilding:"5",Buildings:0, Product: 0, Req:[{id:"Copper Wire",Nr:8},{id:"Steel Tube",Nr:3}]}]},
                {id:"Motor",Name:"Motor",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"5",Buildings:0, Product: 0, Req:[{id:"Rotor",Nr:2},{id:"Stator",Nr:2}]}]},
                {id:"Automated Wiring",Name:"Automated Wireng",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"2.5",Buildings:0, Product: 0, Req:[{id:"Cable",Nr:20},{id:"Stator",Nr:1}]}]}
            ],
            [
                {id:"Oil",Name:"Oil",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:120,Buildings:0,Product:0,Req:[]}]},
                {id:"HeavyOilResidue",Name:"Heavy Oil-Residue",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"0",Buildings:null,Product:0,Req:[]}]},
                {id:"Plastic",Name:"Plastic",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"20",Buildings:0,Product:0,Req:[{id:"Oil","Nr":1.5},{id:"HeavyOilResidue","Nr":-0.5}]}]},
                {id:"Rubber",Name:"Rubber",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"20",Buildings:0,Product:0,Req:[{id:"Oil","Nr":1.5},{id:"HeavyOilResidue","Nr":-1}]}]},
                {id:"Polymer Resin",Name:"Polymer Resin",Asked:"0",Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"130",Buildings:0,Product:0,Req:[{id:"Oil","Nr":0.4615},{id:"HeavyOilResidue","Nr":-0.1538}]}]},
                {id:"Petroleum Coke",Name:"Petroleum Coke",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"120",Buildings:0,Product:0,Req:[{id:"HeavyOilResidue","Nr":0.33333333}]}]},
                {id:"Fuel",Name:"Fuel",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"40",Buildings:0,Product:0,Req:[{id:"Oil","Nr":1.5},{id:"Polymer Resin","Nr":0.75}]}]},
                {id:"Canister",Name:"Canister",Asked:0,Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"60",Buildings:0,Product:0,Req:[{id:"Plastic","Nr":0.5}]}]},
                {id:"Circuit Board",Name:"Circuit Board",Asked:"0",Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"7.5",Buildings:0,Product:0,Req:[{id:"Copper SHeet","Nr":2},{id:"Plastic","Nr":4}]}]},
                {id:"Heavy Modular Frame",Name:"Heavy Modular Frame",Asked:"0",Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"2",Buildings:0,Product:0,Req:[{id:"Modular Frame","Nr":5},{id:"Steel Tube","Nr":15},{id:"Encased Industrial Beam","Nr":5},{id:"IronScrew","Nr":100}]}]},
                {id:"Computer",Name:"Computer",Asked:"0",Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"2.5",Buildings:0,Product:0,Req:[{id:"Circuit Board","Nr":10},{id:"Cable","Nr":9},{id:"Plastic","Nr":18},{id:"IronScrew","Nr":52}]}]},
                {id:"Modular Engine",Name:"Modular Engine",Asked:"0",Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"1",Buildings:0,Product:0,Req:[{id:"Motor","Nr":2},{id:"Rubber","Nr":15},{id:"Smart Plating","Nr":2}]}]},
                {id:"Adaptive COntrol Unit",Name:"Adaptive Control Unit",Asked:"0",Needed:0,NeededList:[],RecipeNr: 0,Recepice:[{PerBuilding:"1",Buildings:0,Product:0,Req:[{id:"Automated Wiring","Nr":15},{id:"Circuit Board","Nr":10},{id:"Heavy Modular Frame","Nr":2},{id:"Computer","Nr":2}]}]}
            ]
        ]

        function AddToFactory(NewItem, TierIndex){
            // Check if the item with the same Id already exists
            console.log(TierIndex)
            var existingItem = FactoryItems[TierIndex].find(item => item.id === NewItem.id);
            if (existingItem) {
                console.log('Item '+NewItem.id +' already exists in newest Tier.');
                return; // Exit the function to avoid adding the item again
            }

            FactoryItems[TierIndex].push(NewItem);
            console.log('Item '+NewItem.id+' added to Tier', TierIndex);
        };

        function getIndex(ID){
            var lengTiers =FactoryItems.length  
            for (var j = 0; j < lengTiers; j++) {
                var foundIndex = FactoryItems[j].findIndex(item => item.id === ID);

                if(foundIndex != -1){
                    return [j, foundIndex]
                }
            }
            console.log('Cant find', ID)
            return -1
        }

</script>

<!-- Calulation of Items-->
<script>

        function AddNeeded(ID, DepItem){
            var indexFactor = getIndex(ID)
            var TierIndex = indexFactor[0]
            var ItemIndex = indexFactor[1]
            var item = FactoryItems[TierIndex][ItemIndex];
            item.Needed = Number(DepItem.Nr)+Number(item.Needed);

            var NeededListIndex = item.NeededList.findIndex(item => item.id === DepItem.id);
            if(NeededListIndex === -1)
            {
                item.NeededList.push(DepItem)
            }
            else
            {
                item.NeededList[NeededListIndex].Nr = item.NeededList[NeededListIndex].Nr + Number(DepItem.Nr)
            }
            FactoryItems[TierIndex][ItemIndex] = item;
            CalcOneBuilding(TierIndex, ItemIndex)
            return
        }

        // This always uses the first /standard recipe! 
        // TODO: Set standard by resorting 
        function CalcOneBuilding(j,l){
            var item =  FactoryItems[j][l]
            // Loop over items in recipe
            var length = item.Recepice[item.RecipeNr].Req.length
            for (var l = 0; l < length; l++) {
                AddNeeded(item.Recepice[item.RecipeNr].Req[l].id, {id: item.id, Nr: item.Recepice[item.RecipeNr].Req[l].Nr*item.Needed})
            }
            
        }

        function AddPowers(){
            PowerSources.forEach(Source => {
                Source.Req.forEach(ReqItem => {
                    AddNeeded(ReqItem.id, {id: Source.Name, Nr: Source.Buildings*ReqItem.Nr})
                })
            })
        }


        function CalcAllBuildings(){
            var lengTiers =FactoryItems.length  
            console.log("Tiers: ", lengTiers)
            for (var j = 0; j < lengTiers; j++) {
                var leng =FactoryItems[j].length  
                console.log("Items at tiers ", j, ": ", leng)
                for (var l = 0; l < leng; l++) {
                    FactoryItems[j][l].Needed=0;
                    FactoryItems[j][l].NeededList=[];
                }
            }
            for (var j = 0; j < lengTiers; j++) {
                var leng = FactoryItems[j].length  
                for (var l = 0; l < leng; l++) {
                    if(FactoryItems[j][l].Asked != 0)
                    {
                        FactoryItems[j][l].Needed = Number(FactoryItems[j][l].Asked)+Number(FactoryItems[j][l].Needed);
                        FactoryItems[j][l].NeededList.push({id: "out", Nr: Number(FactoryItems[j][l].Asked)});
                        CalcOneBuilding(j,l);
                    }
                }
            }
            AddPowers()
            for (var j = 0; j < lengTiers; j++) {
                var leng = FactoryItems[j].length  
                for (var l = 0; l < leng; l++) {
                    FactoryItems[j][l].Recepice[FactoryItems[j][l].RecipeNr].Buildings = Math.ceil(FactoryItems[j][l].Needed/ FactoryItems[j][l].Recepice[FactoryItems[j][l].RecipeNr].PerBuilding);
                }
            }
        }
        </script>
<!-- BUild the Main table-->
<script>



        function handleAskedInput(m, InputId,i,key){
            var Input =document.getElementById(InputId);
            console.log("New Asked: ", Input.value);
            FactoryItems[m][i][key]=Input.value;
            BuildAllTables();

        };

        function BuildAllTables(){
            CalcAllBuildings()
            PowerTable()
            RoadTable(0, "table-Factory0")
            RoadTable(1, "table-Factory12")
            RoadTable(2, "table-FactoryMAM")
            RoadTable(3, "table-Factory34")
            RoadTable(4, "table-Factory56")

        }

        function RoadTable(m, TableIdentifier) {
            var tableBody = document.getElementById(TableIdentifier);
            var tbody = document.createElement('tbody'); // Create a new tbody element
            tableBody.innerHTML = ''; // Clear the table body
            var keys = Object.keys(FactoryItems[m][0]);
            keys = keys.slice(1);

            // Name
            var key = keys[0];
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = key;
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                let Cell = document.createElement('td');
                Cell.textContent = FactoryItems[m][i][key];
                let CycleRecipeButton = document.createElement('button')
                CycleRecipeButton.onclick = (function(m, i) {
                    return function() {
                        console.log(FactoryItems[m][i]);
                        FactoryItems[m][i].RecipeNr = (FactoryItems[m][i].RecipeNr + 1) % FactoryItems[m][i].Recepice.length;
                        BuildAllTables() // THis loks recursve, but the function only gets called on cklick!
                    };
                })(m, i);
                CycleRecipeButton.textContent = "Recipe "+(FactoryItems[m][i].RecipeNr+1)+"/"+(FactoryItems[m][i].Recepice.length);
                CycleRecipeButton.style.float = "right";
                Cell.appendChild(CycleRecipeButton);

                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);

            // Asked as Input
            var key = keys[1];
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = key;
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                var Item = FactoryItems[m][i];
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'Input' + Item[keys[0]] + key;
                input.oninput = handleAskedInput.bind(null, m, input.id, i, key);
                input.value = Item[key];
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 
                input.style.width= "50px"  ; 

                Cell.appendChild(input);
                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);

            // Ceil for Number
            var key = keys[2];
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = key;
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                var Cell = document.createElement('td');
                Cell.textContent = Math.ceil(Number( FactoryItems[m][i][key]));
                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);


            // The Recipies
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            {
            var TitleTable = document.createElement('table');

            var Row1 = document.createElement('tr');
            var TitleElem = document.createElement('td');
            TitleElem.textContent = "per Building";
            Row1.appendChild(TitleElem);
            TitleTable.append(Row1);
            var Row2 = document.createElement('tr');
            var TitleElem = document.createElement('td');
            TitleElem.textContent = "Buildings";
            Row2.appendChild(TitleElem);
            TitleTable.append(Row2);
            var Row3 = document.createElement('tr');
            var TitleElem = document.createElement('td');
            TitleElem.textContent = "Produced:";
            Row3.appendChild(TitleElem);
            TitleTable.append(Row3);
            
            TitleCell.append(TitleTable);
            }
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                var TableCell = document.createElement('td');

                // var RecepiceList = FactoryItems[m][i].Recepice;
                
                var Recepicekeys = Object.keys(FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr]);
                var RecepiceTable = document.createElement('table');
                for(var l= 0; l < 3; l++)
                {
                    var RecepiceRow =  document.createElement('tr')
                    var ValueCell = document.createElement('td');

                    ValueCell.textContent = FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr][Recepicekeys[l]];
                    RecepiceRow.appendChild(ValueCell)
                    //for (var j = 0; j < RecepiceList.length; j++) {
                    //    var ValueCell = document.createElement('td');

                    //    ValueCell.textContent = RecepiceList[j][Recepicekeys[l]];
                    //     RecepiceRow.appendChild(ValueCell)
                    // }

                    RecepiceTable.appendChild(RecepiceRow)
                }
                var RecepiceRow =  document.createElement('tr')

                /*
                for (var j = 0; j < RecepiceList.length; j++) {
                    var ValueCell = document.createElement('td');
                    RecepiceList[j].ByProducts.forEach(function(ByProductItem){
                        var ByProductCell = document.createElement('td')
                        ValueCell.textContent = "Item: " + ByProductItem.id *" at " + ByProductItem.Nr 
                    });
                    RecepiceRow.appendChild(ValueCell)
                    
                }
                    */
                RecepiceTable.appendChild(RecepiceRow)
                
                TableCell.appendChild(RecepiceTable);
                Row.appendChild(TableCell);
            }
            tbody.appendChild(Row);



            // Needed List as Building Numbers
            var key = keys[3];
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.style.width = "200px"
            TitleCell.textContent = "Need per Item";
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                var Cell = document.createElement('td');
                var NeededList = FactoryItems[m][i][key];
                var NeededTable = document.createElement('table');
                for (var j = 0; j < NeededList.length; j++) {
                    var NeededRow =  document.createElement('tr')
                    var Cell1 = document.createElement('td')
                    Cell1.textContent = NeededList[j].id
                    var Cell2 = document.createElement('td')
                    Cell2.textContent = Math.ceil(NeededList[j].Nr/FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr].PerBuilding)
                    var Cell3 = document.createElement('td')
                    Cell3.textContent = Math.ceil(NeededList[j].Nr)
                    NeededRow.appendChild(Cell1)
                    NeededRow.appendChild(Cell2)
                    NeededRow.appendChild(Cell3)
                    if(NeededList[j].Nr != 0 ){
                        NeededTable.appendChild(NeededRow)
                    }
                }
                Cell.appendChild(NeededTable)
                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);


            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = "Overhead";
            Row.appendChild(TitleCell);
            for (var i = 0; i < FactoryItems[m].length; i++) {
                var Cell = document.createElement('td');
                Cell.textContent = FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr].Buildings*FactoryItems[m][i].Recepice[FactoryItems[m][i].RecipeNr].PerBuilding - FactoryItems[m][i].Needed;
                Row.appendChild(Cell);
            }
            tbody.appendChild(Row);

            tableBody.appendChild(tbody)
        }
    </script>

<!-- Adding new Items/Recipies-->
    <script>
        var NewItem = {
                id: "", Name: "",
                Asked: 0, Needed:0,
                NeededList:[],
                RecipeNr:0,
                Recepice:[
                ]
            };
            var NewRecepice = {PerBuilding:0,Buildings:0, Product: 0, Req:[]}

        function NewItemAddRecipe(){
            PerBuildingField = document.getElementById("InputAddingPerBuilding")
            NewRecepice.PerBuilding = PerBuildingField.value
            NewItem.Recepice.push(NewRecepice)
            resetNewRecepice();
        }
        function AddAlternativeRecipe(ItemID)
        {
            var PerBuildingField = document.getElementById("InputAddingPerBuilding")
            NewRecepice.PerBuilding = PerBuildingField.value
            var index = getIndex(ItemID)

            FactoryItems[index[0]][index[1]].Recepice.push(NewRecepice)
            resetNewRecepice();
            return
        }

        function AddNewItem(){
            NewItemAddRecipe()
            NameField = document.getElementById("InputAddingName")
            NewItem.id  = NameField.value
            NewItem.Name  = NameField.value

            
            TierField = document.getElementById("InputAddingTier");

            AddToFactory(NewItem, TierField.value)
            console.log("Addign item: ", NewItem)
            resetNewItem();
        }
        function handleAddButton(){
            var NameField = document.getElementById("InputAddingName")
            var index = getIndex( NameField.value)
            console.log("NEw item name: ", NameField.value)
            console.log("FOund at ", index)
            if( index === -1){
                AddNewItem()
            }
            else(
                AddAlternativeRecipe(NameField.value)
            )

            BuildAllTables()

        }
        function resetNewItem(){
            NewItem = {
                id: "", Name: "",
                Asked: 0, Needed:0,
                NeededList:[],
                Recepice:[
                ]
            };
            NewRecepice = {PerBuilding:0,Buildings:0, Product: 0, Req:[]}
            BuildAddTable()
        }
        function resetNewRecepice(){
            NewRecepice = {PerBuilding:0,Buildings:0, Product: 0, Req:[]}
        }
        
        function handleAddReqButton(){
            console.log("adding req")
            var ReqItem ={id: '', Nr: 1};

            ReqNameField = document.getElementById("InputAddingReqItem")
            ReqItem.id  = ReqNameField.value;
            PerBuildingField = document.getElementById("InputAddingReqNumber")
            ReqItem.Nr = Number(PerBuildingField.value)

            NewRecepice.Req.push(ReqItem)

            // Add to table to see
            var Row = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = "";
            Row.appendChild(TitleCell);
            var Cell = document.createElement('td');
            Cell.textContent = ReqItem.id;
            Row.appendChild(Cell);
            var Cell = document.createElement('td');
            Cell.textContent = ReqItem.Nr;
            Row.appendChild(Cell);

            tbody = document.getElementById("tbodyAdd")
            tbody.appendChild(Row)
        }

        function BuildAddTable() {
            CalcAllBuildings()
                var tableBody = document.getElementById('add-Factory');
                var tbody = document.createElement('tbody'); // Create a new tbody element
                tbody.id = "tbodyAdd"
                tableBody.innerHTML = ''; // Clear the table body
                var keys = Object.keys(FactoryItems[0][0]);


            var TierRow = document.createElement('tr');
            var TitleCell = document.createElement('td');
            TitleCell.textContent = "Tier";
            TitleCell.style.width = "200px"
            TierRow.appendChild(TitleCell);
            {
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputAddingTier';
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 
                input.value = 3;
                Cell.appendChild(input);
                TierRow.appendChild(Cell);
            }
            tbody.appendChild(TierRow);


            {
                var key = "Name";
                var NameRow = document.createElement('tr');
                var TitleCell = document.createElement('td');
                TitleCell.textContent = key;
                NameRow.appendChild(TitleCell);
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputAdding' + key;
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 

                Cell.appendChild(input);
                NameRow.appendChild(Cell);
                tbody.appendChild(NameRow);
            }
            {
                NewItem.Recepice.forEach(function(Recipe){
                    RecipRow = document.createElement('tr');
                    var TitleCell = document.createElement('td');
                    TitleCell.textContent = "Recipe";
                    RecipRow.appendChild(TitleCell);
                    var ReqCell = document.createElement('td');
                    

                });
            }
            {
                var key = "PerBuilding";
                var PerRow = document.createElement('tr');
                var TitleCell = document.createElement('td');
                TitleCell.textContent = key;
                PerRow.appendChild(TitleCell);
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputAdding' + key;
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 

                Cell.appendChild(input);
                PerRow.appendChild(Cell);
                tbody.appendChild(PerRow);
            }

            {
                var ReqRow = document.createElement('tr');
                var TitleCell = document.createElement('td');
                TitleCell.style.whiteSpace = "pre"
                TitleCell.textContent = "Requirements\nEnter byproducts as negative needs";
                ReqRow.appendChild(TitleCell);

                {
                    var DropDownCell = document.createElement('td');
                    var DropDownSelect = document.createElement("select");
                    DropDownSelect.id = "InputAddingReqItem";

                    // Populate the drop-down with items from FactoryItems
                    FactoryItems.forEach(function(FactoryTier) {
                        FactoryTier.forEach(function(item) {
                            var option = document.createElement("option");
                            option.value = item.id;
                            option.text = item.Name;
                            DropDownSelect.appendChild(option);
                        })
                    });
                    DropDownCell.appendChild(DropDownSelect);
                    ReqRow.appendChild(DropDownCell);
                }

                {
                    var NumberCell = document.createElement('td');
                    var input = document.createElement('input');
                    input.id = 'InputAddingReqNumber';
                    input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                    input.style.opacity= 1.5  ; 

                    NumberCell.appendChild(input);
                    ReqRow.appendChild(NumberCell);
                }
                {
                var AddCell = document.createElement('td');
                var AddReqButton = document.createElement('button');
                AddReqButton.id = "AddReqButton"
                AddReqButton.textContent = "Add";
                AddReqButton.onclick=handleAddReqButton;
                AddCell.appendChild(AddReqButton);
                ReqRow.appendChild(AddCell);
                }
            
                tbody.appendChild(ReqRow);
            }

            tableBody.appendChild(tbody)
        }

    </script>



    <!--Saving -->
    <script>

        function saveState() {
            console.log("Saveing");
            CalcAllBuildings();
            localStorage.setItem('FactoryItemsTier0' , JSON.stringify(FactoryItems[0]));
            localStorage.setItem('FactoryItemsTier12', JSON.stringify(FactoryItems[1]));
            localStorage.setItem('FactoryItemsTier34', JSON.stringify(FactoryItems[2]));
            localStorage.setItem('FactoryItemsTier56', JSON.stringify(FactoryItems[3]));
            console.log("Saved");
            }

    
        function loadFactory() {
            var storedFactoryItemsTier0     = localStorage.getItem('FactoryItemsTier0');
            var storedFactoryItemsTier12     = localStorage.getItem('FactoryItemsTier12');
            var storedFactoryItemsTier34     = localStorage.getItem('FactoryItemsTier34');
            var storedFactoryItemsTier56     = localStorage.getItem('FactoryItemsTier56');

            if (storedFactoryItemsTier0) {
                FactoryItems[0] = JSON.parse(storedFactoryItemsTier0);
            }
            if (storedFactoryItemsTier12) {
                FactoryItems[1] = JSON.parse(storedFactoryItemsTier12);
            }
            if (storedFactoryItemsTier34) {
                FactoryItems[3] = JSON.parse(storedFactoryItemsTier34);
            }
            if (storedFactoryItemsTier56) {
                FactoryItems[4] = JSON.parse(storedFactoryItemsTier56);
            }
        }
    </script>
<!-- Determin the building-->
<script>
     // var Buildings = [Constructor, Assembler, Manufactorer, Refinery, Blender, smelter, Foundary, Miner, Water, Oil ]
    function BuildingType(Recepie){
        var fluids = ["Water", "Oil", "Fuel", "HeavyOilResidue"];
        var Ores = ["IreonOre", "CopperOre", "Caterium Ore"];
        if(Recepie.Req.some(req => fluids.includes(req.id)))
        {
            if(Recepie.Req.length <3){
                return 3
            }
            else{
                return 4
            }
        }
        else{
            if(Recepie.Req.length === 1){
                if(Recepie.Req.some(req => Ores.includes(req.id))){
                    return 5
                }
                else{ return 0}
            }
            if(Recepie.Req.length === 2){
                if(Recepie.Req.some(req => Ores.includes(req.id))){
                    return 6
                }
                else{ return 1}
            }
            if(Recepie.Req.length > 2){
                return 2
            }
        }
    }

    FactoryItems.forEach(Tier => {
        Tier.forEach(Item=>{
            Item.Recepice.forEach(Rec => {console.log(Item.Name, BuildingType(Rec))})
        })
    })
</script>

<!-- Power-->
<script>
    var PowerSources = [
    {Name: "Biomass Burner", Buildings: 0, PerBuilding: 35, Req: []},
    {Name: "Coal Power Plant", Buildings: 0, PerBuilding: 75, Req: [{id: "Water", Nr: 45}, {id: "Coal", Nr: 15}]},
    {Name: "Fuel Power Plant", Buildings: 0, PerBuilding: 125, Req: [{id: "Fuel", Nr: 15}]},
    ]
    // var Buildings = [Constructor, Assembler, Manufactorer, Refinery, Blender, smelter, Foundary, Miner, Water, Oil ]
    var BuildingsPower = [4, 15, 55, 30,75, 4, 16, 12, 20, 40]
    function PowerConsumption(){
        var Demand = 0;
        FactoryItems.forEach(Tier => {
            Tier.forEach(Item=>{
                if(Item.Recepice[Item.RecipeNr].Req.length == 0)
                {

                }
                else{
                    // console.log(Item.Name, Item.Recepice.length, BuildingType(Item.Recepice[Item.RecipeNr]))
                    Demand += (
                        Item.Recepice[Item.RecipeNr].Buildings
                        *BuildingsPower[ BuildingType(Item.Recepice[Item.RecipeNr])]
                    )
                }
            })
        })

        return Demand
        //TODO obvsl
    }

    function PowerProduction(){
        var production = 0;
        PowerSources.forEach(source => {
            production += source.Buildings*source.PerBuilding;
        })
        return production
    }

    function handlePowerBuildingInput(NAME){
        var inputfield = document.getElementById('InputPower'+NAME)
        var foundIndex = PowerSources.findIndex(
            item => item.Name === NAME);
        if(foundIndex === -1){
            console.log('Cant find', ID)
            return -1
        }
        PowerSources[foundIndex].Buildings = inputfield.value;
        PowerTable()    
        BuildAllTables()
    }


    function PowerTable()
    {
        var tableBody = document.getElementById('table-Power');
        var tbody = document.createElement('tbody'); // Create a new tbody element
        tbody.id = "tbodyAdd"
        tableBody.innerHTML = ''; // Clear the table body
        //Titles
        {
            var TitleRow = document.createElement('tr')
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Power"
                TitleRow.appendChild(TitleCell)
            }
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Demand"
                TitleRow.appendChild(TitleCell)
            }
            PowerSources.forEach(element => {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = element.Name
                TitleRow.appendChild(TitleCell)
            });
            tbody.appendChild(TitleRow)
        }
        
        // Power Production
        {
            var ProdRow = document.createElement('tr')
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Production"
                ProdRow.appendChild(TitleCell)
            }
            {
                var TitleCell2 = document.createElement('td')
                TitleCell2.textContent = String(PowerProduction()) + "/" + String(PowerConsumption())
                ProdRow.appendChild(TitleCell2)
            }
            PowerSources.forEach(element => {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = element.Buildings*element.PerBuilding
                ProdRow.appendChild(TitleCell)
            });
            tbody.appendChild(ProdRow)
        }
        {
            var BuildingsRow = document.createElement('tr')
            {
                var TitleCell = document.createElement('td')
                TitleCell.textContent = "Buildings"
                BuildingsRow.appendChild(TitleCell)
            }
            {
                var TitleCell2 = document.createElement('td')
                BuildingsRow.appendChild(TitleCell2)
            }
            PowerSources.forEach(element => {
                var Cell = document.createElement('td');
                var input = document.createElement('input');
                input.id = 'InputPower'+element.Name;
                input.oninput = handlePowerBuildingInput.bind(null, element.Name);
                input.value = element.Buildings;
                input.style.backgroundColor= 'transparent'; /* Set the background color to transparent */
                input.style.opacity= 1.5  ; 
                input.style.width= "50px"  ; 

                Cell.appendChild(input);
                BuildingsRow.appendChild(Cell);
            });
            tbody.appendChild(BuildingsRow)
        }
        tableBody.appendChild(tbody)


    }

    </script>


</head>

<body>

<h1> Factory planer</h1>
        <h2> Items</h2>
        <h3> Tier 0</h3>
        <div id="table-container0">
        <table id="table-Factory0">
        </table>
        </div>
        <h3> Tiers 1 and 2</h3>
        <div id="table-container12">
        <table id="table-Factory12">
        </table>
        </div>
        <h3> MAM Research</h3>
        <div id="table-containerMAM">
        <table id="table-FactoryMAM">
        </table>
        </div>
        <h3> Tiers 3 and 4</h3>
        <div id="table-container34">
        <table id="table-Factory34">
        </table>
        </div>
        <h3> Tiers 5 and 6</h3>
        <div id="table-container56">
        <table id="table-Factory56">
        </table>
        </div>
        <button onclick=BuildAllTables()>Recalulate</button>
        <button onclick=saveState()>Saving</button>

        <h2> Add New Recipe:</h2>
        If the name is already taken, the recipe gets added as an alternate
        <br>
        IF you want to use two recipies for the same item,
        the curent best practice is to add the alternative item as an extra Recipe
        with the item as a byprodukt and as well as main product,
        then manually set the prevered production rate as Asked.
        
        <br>
        You can also use this to create "factory modules".
        Seperatly calulate the in and output of the
        moduls, e.g. in a seperate tab, and include them as a new "Item".
        You maually have to set the number via the "asked" fields later.
        <div id="Add-container">
        <table id="add-Factory">
        </table>
        </div>
        <button id= "AddToFactoryButton" onclick=handleAddButton()>Add</button>
        <button id= "ResetNEwItem" onclick=resetNewItem()>Reset Requirements</button>


        <h2> Power </h2>
        <div id="table-containerpower">
            <table id="table-Power">
            </table>
        </div>

    </body>
